<% if @email %>
    <div style="margin-bottom: 20px;">
        <a href="/" style="color: #007bff; text-decoration: none;">‚Üê Back to Email List</a>
    </div>

    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h2 style="margin: 0 0 16px 0; color: #333;"><%= @email[:subject] %></h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px;">
            <div>
                <strong>From:</strong> <%= @email[:sender_name] %> &lt;<%= @email[:sender_email] %>&gt;<br>
                <strong>Date:</strong> <%= @email[:created_at].strftime('%B %d, %Y at %I:%M %p') %><br>
                <strong>Flag Reason:</strong> <span class="flag-reason"><%= @email[:flag_reason] %></span>
            </div>
            <div>
                <% if @email[:responded] %>
                    <span class="responded">‚úì Response Sent</span>
                    <% if @email[:days_to_response] %>
                        <br><small>Response time: <%= @email[:days_to_response] %> days</small>
                    <% end %>
                    <% if @email[:response_category] %>
                        <br><small>Category: <%= @email[:response_category] %></small>
                    <% end %>
                <% else %>
                    <span class="not-responded">‚è≥ Awaiting Response</span>
                <% end %>
            </div>
        </div>
    </div>

    <!-- AI Analysis Section -->
    <% if @email[:ai_reasoning] %>
    <div style="background: #e8f4f8; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0078d4;">
        <h4 style="margin: 0 0 12px 0; color: #0078d4; display: flex; align-items: center;">
            ü§ñ AI Analysis: What the system detected
        </h4>
        <div style="background: #fff; padding: 12px; border-radius: 4px; font-family: 'Segoe UI', sans-serif; line-height: 1.5;">
            <%= @email[:ai_reasoning] %>
        </div>
        <% if @email[:ai_confidence] %>
            <div style="margin-top: 8px; font-size: 12px; color: #605e5c;">
                Confidence: <%= (@email[:ai_confidence].to_f * 100).round(1) %>%
            </div>
        <% end %>
    </div>
    <% end %>

    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
        <div style="padding: 16px; border-bottom: 1px solid #eee; background: #f8f9fa;">
            <h3 style="margin: 0; font-size: 16px;">Email Content</h3>
        </div>
        
        <div style="padding: 20px;">
            <% if @email[:body_html] && !@email[:body_html].empty? %>
                <div id="html-content" style="border: 1px solid #eee; padding: 16px; border-radius: 4px; background: #fafafa;">
                    <%= @email[:body_html] %>
                </div>
            <% elsif @email[:body_text] && !@email[:body_text].empty? %>
                <div id="text-content" style="white-space: pre-wrap; font-family: monospace; background: #f8f9fa; padding: 16px; border-radius: 4px; border: 1px solid #eee;">
<%= @email[:body_text] %></div>
            <% else %>
                <div style="text-align: center; color: #999; padding: 40px;">
                    <em>No email content available</em>
                </div>
            <% end %>
        </div>
    </div>

    <!-- AI Response Generation Area -->
    <div style="margin-top: 20px; padding: 16px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #17a2b8;">
        <h4 style="margin: 0 0 12px 0; color: #155724;">ü§ñ Generate AI Response</h4>
        
        <!-- User Context Input -->
        <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                Add Context for AI (optional):
            </label>
            <textarea id="userContext" 
                      style="width: 100%; min-height: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Segoe UI', sans-serif; resize: vertical;"
                      placeholder="Add any specific context, notes, or instructions for the AI...&#10;Examples:&#10;- This is a VIP customer&#10;- They had a previous issue with order #12345&#10;- Offer them expedited shipping&#10;- They prefer formal communication"></textarea>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; align-items: center;">
            <button id="generateResponse" 
                    onclick="generateDraftResponse()" 
                    style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; font-weight: 500;">
                üìù Generate Draft Response
            </button>
            <div id="loadingIndicator" style="display: none; color: #666;">
                ‚è≥ Generating response...
            </div>
        </div>
    </div>
    
    <!-- Generated Response Area (hidden initially) -->
    <div id="responseArea" style="display: none; margin-top: 20px; padding: 16px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #28a745;">
        <h4 style="margin: 0 0 12px 0; color: #28a745;">‚úÖ Generated Response</h4>
        <div id="generatedResponse" style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif;"></div>
        
        <div style="margin-top: 12px; display: flex; gap: 12px;">
            <button onclick="sendResponse()" 
                    style="padding: 8px 16px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">
                üìß Send Response
            </button>
            <button onclick="regenerateResponse()" 
                    style="padding: 8px 16px; border: none; background: #6c757d; color: white; border-radius: 4px; cursor: pointer;">
                üîÑ Regenerate
            </button>
            <button onclick="copyToClipboard()" 
                    style="padding: 8px 16px; border: none; background: #17a2b8; color: white; border-radius: 4px; cursor: pointer;">
                üìã Copy
            </button>
        </div>
    </div>
    
    <script>
        function generateDraftResponse() {
            const userContext = document.getElementById('userContext').value;
            const loadingIndicator = document.getElementById('loadingIndicator');
            const generateBtn = document.getElementById('generateResponse');
            const responseArea = document.getElementById('responseArea');
            
            // Show loading
            loadingIndicator.style.display = 'block';
            generateBtn.disabled = true;
            
            // Make API call with user context
            fetch('/api/generate-response/<%= @email[:message_id] %>', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_context: userContext
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('generatedResponse').textContent = data.response;
                    responseArea.style.display = 'block';
                } else {
                    alert('Failed to generate response: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error generating response: ' + error.message);
            })
            .finally(() => {
                loadingIndicator.style.display = 'none';
                generateBtn.disabled = false;
            });
        }
        
        function regenerateResponse() {
            // Clear the response and generate again
            document.getElementById('responseArea').style.display = 'none';
            generateDraftResponse();
        }
        
        function copyToClipboard() {
            const responseText = document.getElementById('generatedResponse').textContent;
            navigator.clipboard.writeText(responseText).then(() => {
                alert('Response copied to clipboard!');
            });
        }
        
        function sendResponse() {
            if (confirm('Send this response to the customer?')) {
                const responseText = document.getElementById('generatedResponse').textContent;
                fetch('/api/send-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message_id: '<%= @email[:message_id] %>',
                        response_text: responseText,
                        subject: 'Re: <%= @email[:subject].gsub("'", "\\'") %>'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Response sent successfully!');
                        window.location.href = '/';
                    } else {
                        alert('Failed to send response: ' + (data.error || 'Unknown error'));
                    }
                });
            }
        }
    </script>

<% else %>
    <div style="text-align: center; padding: 40px; color: #666;">
        <h3>Email not found</h3>
        <p><a href="/" style="color: #007bff;">‚Üê Back to Email List</a></p>
    </div>
<% end %>